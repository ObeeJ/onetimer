package controllers

import (
	"context"
	"time"

	"github.com/gofiber/fiber/v2"
	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"

	"onetimer-backend/backend/dto"
	"onetimer-backend/backend/errors"
	"onetimer-backend/backend/models"
	"onetimer-backend/backend/validation"
)

type ValidatedSurveyController struct {
	db *pgxpool.Pool
}

func NewValidatedSurveyController(db *pgxpool.Pool) *ValidatedSurveyController {
	return &ValidatedSurveyController{db: db}
}

func (sc *ValidatedSurveyController) CreateSurvey(c *fiber.Ctx) error {
	var req dto.CreateSurveyRequest
	if err := c.BodyParser(&req); err != nil {
		return errors.HandleError(c, errors.ErrBadRequest)
	}

	if err := validation.ValidateStruct(req); err != nil {
		return errors.HandleError(c, errors.NewValidationError(map[string]interface{}{
			"validation_errors": err,
		}))
	}

	// Get user ID from JWT middleware
	userID, ok := c.Locals("user_id").(string)
	if !ok {
		return errors.HandleError(c, errors.ErrUnauthorized)
	}

	creatorID, err := uuid.Parse(userID)
	if err != nil {
		return errors.HandleError(c, errors.ErrBadRequest)
	}

	survey := models.Survey{
		ID:                uuid.New(),
		CreatorID:         creatorID,
		Title:             req.Title,
		Description:       req.Description,
		Category:          &req.Category,
		RewardAmount:      req.RewardAmount,
		EstimatedDuration: req.EstimatedDuration,
		TargetResponses:   req.TargetResponses,
		CurrentResponses:  0,
		Status:            "draft",
		CreatedAt:         time.Now(),
		UpdatedAt:         time.Now(),
	}

	query := `
		INSERT INTO surveys (id, creator_id, title, description, category, reward_amount, 
			estimated_duration, target_responses, current_responses, status, created_at, updated_at)
		VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
	`

	_, err = sc.db.Exec(context.Background(), query,
		survey.ID, survey.CreatorID, survey.Title, survey.Description,
		survey.Category, survey.RewardAmount, survey.EstimatedDuration,
		survey.TargetResponses, survey.CurrentResponses, survey.Status,
		survey.CreatedAt, survey.UpdatedAt,
	)

	if err != nil {
		return errors.HandleError(c, errors.ErrInternalServer)
	}

	response := dto.SurveyResponse{
		ID:                survey.ID.String(),
		CreatorID:         survey.CreatorID.String(),
		Title:             survey.Title,
		Description:       survey.Description,
		Category:          *survey.Category,
		RewardAmount:      survey.RewardAmount,
		EstimatedDuration: survey.EstimatedDuration,
		TargetResponses:   survey.TargetResponses,
		CurrentResponses:  survey.CurrentResponses,
		Status:            survey.Status,
		CreatedAt:         survey.CreatedAt.Format(time.RFC3339),
		UpdatedAt:         survey.UpdatedAt.Format(time.RFC3339),
	}

	return c.Status(fiber.StatusCreated).JSON(fiber.Map{
		"success": true,
		"data":    response,
	})
}

func (sc *ValidatedSurveyController) GetSurvey(c *fiber.Ctx) error {
	surveyID := c.Params("id")
	if surveyID == "" {
		return errors.HandleError(c, errors.ErrBadRequest)
	}

	id, err := uuid.Parse(surveyID)
	if err != nil {
		return errors.HandleError(c, errors.ErrBadRequest)
	}

	var survey models.Survey
	query := `
		SELECT id, creator_id, title, description, category, reward_amount,
			estimated_duration, target_responses, current_responses, status,
			created_at, updated_at, expires_at
		FROM surveys WHERE id = $1
	`

	err = sc.db.QueryRow(context.Background(), query, id).Scan(
		&survey.ID, &survey.CreatorID, &survey.Title, &survey.Description,
		&survey.Category, &survey.RewardAmount, &survey.EstimatedDuration,
		&survey.TargetResponses, &survey.CurrentResponses, &survey.Status,
		&survey.CreatedAt, &survey.UpdatedAt, &survey.ExpiresAt,
	)

	if err != nil {
		return errors.HandleError(c, errors.NewNotFoundError("Survey"))
	}

	response := dto.SurveyResponse{
		ID:                survey.ID.String(),
		CreatorID:         survey.CreatorID.String(),
		Title:             survey.Title,
		Description:       survey.Description,
		Category:          *survey.Category,
		RewardAmount:      survey.RewardAmount,
		EstimatedDuration: survey.EstimatedDuration,
		TargetResponses:   survey.TargetResponses,
		CurrentResponses:  survey.CurrentResponses,
		Status:            survey.Status,
		CreatedAt:         survey.CreatedAt.Format(time.RFC3339),
		UpdatedAt:         survey.UpdatedAt.Format(time.RFC3339),
	}

	if survey.ExpiresAt != nil {
		expiresAt := survey.ExpiresAt.Format(time.RFC3339)
		response.ExpiresAt = &expiresAt
	}

	return c.JSON(fiber.Map{
		"success": true,
		"data":    response,
	})
}
